# Royalnavy.io

[![CircleCI](https://circleci.com/gh/Royal-Navy/royalnavy.io/tree/master.svg?style=svg&circle-token=088460eafd759c625b9bdcfa5b9d5c59f82fbb2c)](https://circleci.com/gh/Royal-Navy/royalnavy.io/tree/master)
[![Maintainability](https://api.codeclimate.com/v1/badges/41a59d85f86676b4bcf0/maintainability)](https://codeclimate.com/repos/5c7e5acb8824ec5e1c00e2af/maintainability)
[![Test Coverage](https://api.codeclimate.com/v1/badges/41a59d85f86676b4bcf0/test_coverage)](https://codeclimate.com/repos/5c7e5acb8824ec5e1c00e2af/test_coverage)
[![Built With Gatsby](https://img.shields.io/badge/Built%20with-GatsbyJs-blueviolet.svg?logo=gatsby)](https://www.gatsbyjs.org/)

The codebase for the royalnavy.io site. It is based on [GatsbyJs](https://www.gatsbyjs.org/)

> **NOTE:**   
 If you are looking for the documentation for this site, you can find it [here](https://github.com/Royal-Navy/standards-toolkit) under `packages/documentation`.

## How to use this repo

### Step one: Installation

In a command line application, simply run `npm install`. This will go and find all the required dependencies and install them.

> **Note:**  
 This currently contains package dependencies from GitHub.   These may take some time to install and will reside in a  `git_modules` folder. Do not delete this folder.

### Step two: Running the project

Although this is a Gatsby project, the current reliance on GitHub modules requires a slight alteration to running the project. Instead of running `gatsby develop`, please run `npm run develop`. This will ensure you have the latest version of the documentation.

When you have run this command you will be able to find a development copy of the site running at http://localhost:8000. If you wish to see the GraphQL interface, then you can see this at http://localhost:8000/___graphql

## Information for developers  

### Linting

Linting is carried out using Prettier and EsLint, we recommend you download the prettier plugin for your preferred IDE or you can run `npm run lint` in your console, 

> **Note:** Linting is carried out automatically when code is pushed to the repo and a Pull Reqeust is raised. Our checks are run [CodeClimate](https://codeclimate.com) on GitHub.


### Adding new post components

If you want a new component to be available to the markdown renderer, it needs to be imported and registered in the `post-article` component (/src/components/post-article/index.js). Look out for the section below and add your new component to the list:

```js
  const renderAst = new rehypeReact({
    createElement: React.createElement,
    components: {
      'note-block': NoteBlock,
      'info-box': InfoBox,
      'grid-container': GridContainer,
      'content-box': ContentBox,
      'swatch': Swatch,
    },
  }).Compiler?
```

### Using the Docs Consolidator

The consolidator runs automatically every time you run `yarn build` or `yarn start`. Or you can run it manually by running `yarn consolidate-docs`. If you want to start the project without the consolidator, you can run `yarn develop`.

#### How the consolidator works

The consolidator builds up a page structure for the site inside `./src/library/pages` It takes the content from the following places in the following order:

1. The `/library/pages` folder in the `documentation` package
2. The component folder of any package specified in the `packages` array of `package.json` in this package
3. The `./src/local-library` folder of this package

The consolidator copies all pages it finds in #1 and then recursively loops through the contents of `/components`. It then loops through all of the packages from #2 and looks for a `README.md` (case insensitive) file in every component of that package. It reads the file and checks the frontmatter title to see if it matches the frontmatter title (case insensitive) of any of the documentation files. 

If so then it looks within the documentation file for the first instance of a `<framework-tabs>` tags. It then creates a new `<implementation>` tag inside that tag for each package which has a matching component. (Components can be excluded from docs via use of an `exclude` parameter e.g. `<framework-tabs exclude="react, vue">` will make the script ignore any react and vue components that match the doc).

Finally it will copy any files from `.src/local-library/pages` over the top of any matching files in `./src/library/pages`, this is a destructive overwrite as the purpose of this folder is that it's a dominant source specifically for overriding documents. Note: It's not possible to consolidate `local-library` docs at this present moment in time so any file in there must already be in a publishable state.

#### The Local Library
The `./src/library` folder is entirely generated by the consolidator and is therefore not something which can be commited to git. The `./src/local-library` can be committed. 

Any file placed in this folder will be copied wholesale to the library folder post-generation. This makes the version in `local-library` the definitive version. It will supercede any existing file with a matching path or add pages which are not meant to be in the documentation repo.

## Contacting the standards team

If you are having any problems running this repository, you can either raise an [issue](https://github.com/Royal-Navy/royalnavy.io/issues) or email us at [standards@royalnavy.io](standards@royalnavy.io).
