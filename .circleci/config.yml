version: 2.1

aliases:
  - &authenticate_npm
      run:
        name: Authenticate NPM
        command: echo "//$NPM_REGISTRY/:_authToken=$NPM_AUTH_TOKEN" > ~/.npmrc
  - &build_icon_library
      run:
        name: Build Icon Library
        command: yarn --cwd packages/icon-library build
  - &docker
      - image: circleci/node:12.13.0

commands:
  dependencies:
    description: 'Load dependency cache, get dependencies and update cache'
    steps:
      - restore_cache:
          keys:
            - yarn-packages-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - yarn-packages-v1-{{ .Branch }}-
            - yarn-packages-v1-
      - run: yarn install
      - save_cache:
          paths:
            - ~/.cache/yarn
          key: yarn-packages-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}
  publish_package:
    description: 'Publish an NPM package to a registry'
    parameters:
      working_directory_name:
          type: string
          description: 'Name of package'
      tag:
          type: string
          default: latest
          description: 'The NPM dist-tag associated with the release'
    steps:
      - run:
          name: Publish package
          working_directory: packages/<< parameters.working_directory_name >>
          command: npm publish --registry https://$NPM_REGISTRY --tag << parameters.tag >>

jobs:
  security_audit:
    docker: *docker
    steps:
      - checkout
      - run: yarn audit
  lint_commits:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - run: node ./scripts/commitlint $CIRCLE_PULL_REQUEST
  lint_css-framework:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - run: mkdir -p packages/css-framework/test-results/stylelint
      - run: yarn --cwd packages/css-framework --silent stylelint --custom-formatter '../../node_modules/stylelint-junit-formatter/index.js' ./index.scss > packages/css-framework/test-results/stylelint/results.xml
      - store_test_results:
          path: packages/css-framework/test-results/stylelint
      - store_artifacts:
          path: packages/css-framework/test-results/stylelint
  lint_react-component-library:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - run: mkdir -p packages/react-component-library/test-results/eslint
      - run:
          name: Lint
          environment:
            ESLINT_JUNIT_OUTPUT: test-results/eslint/react-component-results.xml
          command: yarn --cwd packages/react-component-library lint:ci
      - store_test_results:
          path: packages/react-component-library/test-results
      - store_artifacts:
          path: packages/react-component-library/test-results
  lint_docs_site:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - run: mkdir -p packages/docs-site/test-results/eslint
      - run:
          name: Lint
          environment:
            ESLINT_JUNIT_OUTPUT: test-results/eslint/docs-site-results.xml
          command: yarn --cwd packages/docs-site lint:ci
      - store_test_results:
          path: packages/docs-site/test-results
      - store_artifacts:
          path: packages/docs-site/test-results
  test_react-component-library:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - *build_icon_library
      - run:
          name: Jest
          environment:
            JEST_JUNIT_OUTPUT_DIR: test-results/jest
            JEST_JUNIT_OUTPUT_NAME: react-component-results.xml
          command: yarn --cwd packages/react-component-library jest --ci --coverage --silent --no-cache --reporters=default --reporters=jest-junit --runInBand
      - store_test_results:
          path: packages/react-component-library/test-results
      - store_artifacts:
          path: packages/react-component-library/test-results
      - persist_to_workspace:
          root: packages
          paths:
            - react-component-library/coverage
  code_climate:
    docker: *docker
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - run:
          name: Download Code Climate tool
          command: curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > /tmp/cc-test-reporter
      - run: chmod +x /tmp/cc-test-reporter
      - run:
          name: Convert react results to cc format
          working_directory: ~/project/packages/react-component-library
          command: /tmp/cc-test-reporter format-coverage -t lcov -o ../../workspace/codeclimate.react-component-library.json ../../workspace/react-component-library/coverage/lcov.info
      - run:
          name: Upload CC coverage
          working_directory: ~/project
          command: /tmp/cc-test-reporter upload-coverage -i workspace/codeclimate.react-component-library.json
  test_visual_regression:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - *build_icon_library
      - run:
          name: Run visual regression tests
          command: yarn --cwd packages/react-component-library chromatic --app-code=$CHROMATIC_APP_CODE
  publish_stable_eslint-config-react:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - *authenticate_npm
      - publish_package:
          working_directory_name: eslint-config-react
          tag: stable
  publish_stable_css-framework:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - *authenticate_npm
      - publish_package:
          working_directory_name: css-framework
          tag: stable
  publish_stable_react-component-library:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - *build_icon_library
      - *authenticate_npm
      - publish_package:
          working_directory_name: react-component-library
          tag: stable
  publish_stable_icon-library:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - *authenticate_npm
      - publish_package:
          working_directory_name: icon-library
          tag: stable
  publish_stable_fonts:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - *authenticate_npm
      - publish_package:
          working_directory_name: fonts
          tag: stable
  test_docs-site:
    docker: *docker
    steps:
      - checkout
      - dependencies
      - *build_icon_library
      - run:
          name: Build React Components
          command: yarn --cwd packages/react-component-library build
      - run:
          name: Build site
          command: yarn --cwd packages/docs-site build
      - run:
          name: Jest
          environment:
            JEST_JUNIT_OUTPUT_DIR: test-results/jest
            JEST_JUNIT_OUTPUT_NAME: docs-site-results.xml
          command: yarn --cwd packages/docs-site jest --ci --coverage --silent --no-cache --reporters=default --reporters=jest-junit --runInBand
      - store_test_results:
          path: packages/docs-site/test-results
      - store_artifacts:
          path: packages/docs-site/test-results
      - persist_to_workspace:
          root: packages
          paths:
            - docs-site/coverage

workflows:
  version: 2
  build_and_test_feature:
    jobs:
      - security_audit:
          filters:
            branches:
              ignore:
                - master
                - /^\d\.\d\.\d-hotfix/
      - lint_commits:
          requires:
            - security_audit
      - lint_css-framework:
          requires:
            - security_audit
      - lint_react-component-library:
          requires:
            - security_audit
      - lint_docs_site:
          requires:
            - security_audit
      - test_react-component-library:
          requires:
            - lint_react-component-library
      - code_climate:
          requires:
            - test_react-component-library
      - test_visual_regression:
          requires:
            - test_react-component-library
  build_and_test_master:
    jobs:
      - security_audit:
          filters:
            branches:
              only:
                - master
      - lint_commits:
          requires:
            - security_audit
      - lint_css-framework:
          requires:
            - security_audit
      - lint_react-component-library:
          requires:
            - security_audit
      - lint_docs_site:
          requires:
            - security_audit
      - test_react-component-library:
          requires:
            - lint_react-component-library
      - code_climate:
          requires:
            - test_react-component-library
      - test_visual_regression:
          requires:
            - test_react-component-library
      - publish_stable_eslint-config-react:
          filters:
            tags:
              only:
                - /^\d\.\d\.0/
      - publish_stable_icon-library:
          filters:
            tags:
              only:
                - /^\d\.\d\.0/
      - publish_stable_fonts:
          filters:
            tags:
              only:
                - /^\d\.\d\.0/
      - publish_stable_css-framework:
          requires:
            - lint_css-framework
          filters:
            tags:
              only:
                - /^\d\.\d\.0/
      - publish_stable_react-component-library:
          requires:
            - test_react-component-library
            - publish_stable_css-framework
            - publish_stable_icon-library
          filters:
            tags:
              only:
                - /^\d\.\d\.0/
      - test_docs-site:
          requires:
            - test_react-component-library
  build_and_test_hotfix:
    jobs:
      - security_audit:
          filters:
            branches:
              only:
                - /^\d\.\d\.\d-hotfix/
      - lint_commits:
          requires:
            - security_audit
      - lint_css-framework:
          requires:
            - security_audit
      - lint_react-component-library:
          requires:
            - security_audit
      - lint_docs_site:
          requires:
            - security_audit
      - test_react-component-library:
          requires:
            - lint_react-component-library
      - code_climate:
          requires:
            - test_react-component-library
      - test_visual_regression:
          requires:
            - test_react-component-library
      - publish_stable_eslint-config-react:
          filters:
            tags:
              only:
                - /^\d\.\d\.\d/
      - publish_stable_icon-library:
          filters:
            tags:
              only:
                - /^\d\.\d\.\d/
      - publish_stable_fonts:
          filters:
            tags:
              only:
                - /^\d\.\d\.\d/
      - publish_stable_css-framework:
          requires:
            - lint_css-framework
          filters:
            tags:
              only:
                - /^\d\.\d\.\d/
      - publish_stable_react-component-library:
          requires:
            - test_react-component-library
            - publish_stable_css-framework
            - publish_stable_icon-library
          filters:
            tags:
              only:
                - /^\d\.\d\.\d/
      - test_docs-site:
          requires:
            - test_react-component-library
